<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ –ø–æ URL</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ –ø–æ URL</h1>
    <form id="downloadForm" method="post">
        <input type="url" id="urlInput" name="url" placeholder="–í–≤–µ–¥–∏—Ç–µ URL –≤–∏–¥–µ–æ (YouTube, Vimeo, m3u8)" required>
        <button type="submit" id="submitButton">–°–∫–∞—á–∞—Ç—å</button>
    </form>

    <div class="progress-container" style="display: none;">
        <div id="progressBar" class="progress-bar">0%</div>
    </div>
    <p id="statusMessage"></p>

    <script>
        let downloadId = null;
        let currentEventSource = null;

        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM
        const form = document.getElementById('downloadForm');
        const urlInput = document.getElementById('urlInput');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const submitButton = document.getElementById('submitButton');
        const progressContainer = document.querySelector('.progress-container');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.style.color = isError ? '#f44336' : '#333';
            console.log(`–°—Ç–∞—Ç—É—Å: ${message}`);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ URL
        function validateUrl(url) {
            try {
                const urlObj = new URL(url);
                if (!urlObj.protocol.startsWith('http')) {
                    throw new Error('URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å http:// –∏–ª–∏ https://');
                }
                return true;
            } catch (error) {
                updateStatus(error.message, true);
                return false;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—É—â–µ–≥–æ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function closeCurrentEventSource() {
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã');
            
            const url = urlInput.value.trim();
            console.log('URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', url);
            
            if (!url) {
                updateStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ URL –≤–∏–¥–µ–æ', true);
                return;
            }

            if (!validateUrl(url)) {
                return;
            }
            
            submitButton.disabled = true;
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            updateStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç...');

            try {
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', url);
                
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }

                const data = await response.json();
                downloadId = data.download_id;
                if (!downloadId) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –∑–∞–≥—Ä—É–∑–∫–∏');
                }

                const progressInterval = setInterval(async () => {
                    try {
                        const progressResponse = await fetch(`/sync_progress?download_id=${downloadId}`);
                        if (!progressResponse.ok) {
                            throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞: ${progressResponse.status}`);
                        }
                        
                        const progressData = await progressResponse.json();
                        console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å:', progressData);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä
                        if (progressData.progress !== undefined) {
                            const progress = Math.round(progressData.progress);
                            progressBar.style.width = `${progress}%`;
                            progressBar.textContent = `${progress}%`;
                            
                            if (progress < 100) {
                                updateStatus(`üì• –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: ${progress}%`);
                            }
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
                        if (progressData.status === 'error') {
                            clearInterval(progressInterval);
                            throw new Error(progressData.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');
                        }
                        
                        if (progressData.status === 'completed') {
                            clearInterval(progressInterval);
                            progressBar.style.width = '100%';
                            progressBar.textContent = '100%';
                            updateStatus('‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                            
                            // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ñ–∞–π–ª
                            window.location.href = `/download/${downloadId}`;
                        }
                    } catch (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                        clearInterval(progressInterval);
                        updateStatus(error.message, true);
                    }
                }, 1000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                updateStatus(error.message, true);
                progressContainer.style.display = 'none';
            } finally {
                submitButton.disabled = false;
            }
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Ç–º–µ–Ω—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function (event) {
            if (downloadId) {
                navigator.sendBeacon(`/cancel/${downloadId}`);
            }
            closeCurrentEventSource();
        });
    </script>
</body>
</html>
