<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð²Ð¸Ð´ÐµÐ¾ Ð¿Ð¾ URL</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <h1>Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð²Ð¸Ð´ÐµÐ¾ Ð¿Ð¾ URL</h1>
    <form id="downloadForm" method="post">
        <input type="url" id="urlInput" name="url" placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ URL Ð²Ð¸Ð´ÐµÐ¾ (YouTube, Vimeo, m3u8)" required>
        <button type="submit" id="submitButton">Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ</button>
    </form>

    <div class="progress-container" style="display: none;">
        <div id="progressBar" class="progress-bar">0%</div>
    </div>
    <p id="statusMessage"></p>

    <script>
        let downloadId = null;
        let currentEventSource = null;

        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ DOM
        const form = document.getElementById('downloadForm');
        const urlInput = document.getElementById('urlInput');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const submitButton = document.getElementById('submitButton');
        const progressContainer = document.querySelector('.progress-container');

        // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
        function updateStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.style.color = isError ? '#f44336' : '#333';
            console.log(`Ð¡Ñ‚Ð°Ñ‚ÑƒÑ: ${message}`);
        }

        // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸ URL
        function validateUrl(url) {
            try {
                const urlObj = new URL(url);
                if (!urlObj.protocol.startsWith('http')) {
                    throw new Error('URL Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ‚ÑŒÑÑ Ñ http:// Ð¸Ð»Ð¸ https://');
                }
                return true;
            } catch (error) {
                updateStatus(error.message, true);
                return false;
            }
        }

        // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ SSE ÑÐ¾ÐµÐ´Ð¸Ð½ÐµÐ½Ð¸Ñ
        function closeCurrentEventSource() {
            if (currentEventSource) {
                currentEventSource.close();
                currentEventSource = null;
            }
        }

        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ñ„Ð¾Ñ€Ð¼Ñ‹
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ñ„Ð¾Ñ€Ð¼Ñ‹');
            
            const url = urlInput.value.trim();
            console.log('URL Ð´Ð»Ñ ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ:', url);
            
            if (!url) {
                updateStatus('ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ URL Ð²Ð¸Ð´ÐµÐ¾', true);
                return;
            }

            if (!validateUrl(url)) {
                return;
            }
            
            submitButton.disabled = true;
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            updateStatus('â³ Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð½Ð°Ñ‡Ð°Ð»Ð°ÑÑŒ, ÑÑ‚Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð¼Ð¸Ð½ÑƒÑ‚...');

            try {
                console.log('ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€:', url);
                
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    throw new Error(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð°: ${response.status}`);
                }

                const data = await response.json();
                downloadId = data.download_id;
                if (!downloadId) {
                    throw new Error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ID Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸');
                }

                const progressInterval = setInterval(async () => {
                    try {
                        const progressResponse = await fetch(`/sync_progress?download_id=${downloadId}`);
                        if (progressResponse.ok) {
                            const progressData = await progressResponse.json();
                            if (progressData.progress !== undefined) {
                                progressBar.style.width = `${progressData.progress}%`;
                                progressBar.textContent = `${progressData.progress}%`;
                                
                                if (progressData.progress < 100) {
                                    updateStatus(`ðŸ“¥ Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ÑÑ: ${progressData.progress}%`);
                                }
                            }
                            
                            if (progressData.status === 'completed' || progressData.status === 'error') {
                                clearInterval(progressInterval);
                                
                                if (progressData.status === 'completed') {
                                    const fileResponse = await fetch(`/download_file/${downloadId}`);
                                    if (!fileResponse.ok) {
                                        throw new Error(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ñ: ${fileResponse.status}`);
                                    }
                                    const blob = await fileResponse.blob();
                                    console.log('ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ Ñ„Ð°Ð¹Ð» Ñ€Ð°Ð·Ð¼ÐµÑ€Ð¾Ð¼:', blob.size);
                                    
                                    if (blob.size === 0) {
                                        throw new Error('ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ñ„Ð°Ð¹Ð»');
                                    }

                                    const downloadUrl = window.URL.createObjectURL(blob);
                                    const a = document.createElement('a');
                                    a.style.display = 'none';
                                    a.href = downloadUrl;
                                    a.download = `video_${downloadId}.mp4`;
                                    document.body.appendChild(a);
                                    a.click();
                                    window.URL.revokeObjectURL(downloadUrl);
                                    document.body.removeChild(a);

                                    progressBar.style.width = '100%';
                                    progressBar.textContent = '100%';
                                    updateStatus('âœ… Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!');
                                    statusMessage.style.color = '#4caf50';
                                    urlInput.value = '';
                                }
                            }
                        }
                    } catch (error) {
                        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐ°:', error);
                        clearInterval(progressInterval);
                        updateStatus(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ${error.message}`, true);
                    }
                }, 1000);
            } catch (error) {
                console.error('ÐžÑˆÐ¸Ð±ÐºÐ°:', error);
                updateStatus(error.message, true);
                progressContainer.style.display = 'none';
            } finally {
                submitButton.disabled = false;
            }
        });

        // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð·Ð°Ð¿Ñ€Ð¾ÑÐ° Ð½Ð° Ð¾Ñ‚Ð¼ÐµÐ½Ñƒ Ð¿Ñ€Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸/Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹
        window.addEventListener('beforeunload', function (event) {
            if (downloadId) {
                navigator.sendBeacon(`/cancel/${downloadId}`);
            }
            closeCurrentEventSource();
        });
    </script>
</body>
</html>
