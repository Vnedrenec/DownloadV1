<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Скачать видео по URL</title>
    <link rel="stylesheet" href="/static/style.css">

</head>
<body>
    <h1>Скачать видео по URL</h1>
    <form id="downloadForm" method="post">
        <input type="url" id="urlInput" name="url" placeholder="Введите URL видео (YouTube, Vimeo, m3u8)" required>
        <button type="submit" id="submitButton">Скачать</button>
    </form>

    <div class="progress-container" style="display: none;">
        <div id="progressBar" class="progress-bar">0%</div>
    </div>
    <p id="statusMessage"></p>
    <div id="downloadButtonContainer" style="display: none;">
        <button id="downloadButton" class="download-button">Скачать видео</button>
    </div>

    <script>
        let downloadId = null;
        let lastProgress = 0;

        // Получаем элементы DOM
        const form = document.getElementById('downloadForm');
        const urlInput = document.getElementById('urlInput');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const submitButton = document.getElementById('submitButton');
        const progressContainer = document.querySelector('.progress-container');
        const downloadButtonContainer = document.getElementById('downloadButtonContainer');
        const downloadButton = document.getElementById('downloadButton');

        // Функция для обновления статуса
        function updateStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'error' : '';
            console.log(`Статус: ${message}`);
        }

        // Функция для плавного обновления прогресса
        let animationFrameId = null;
        let targetProgress = 0;
        let currentProgress = 0;
        const animationSpeed = 0.5; // Скорость анимации (0-1)

        function updateProgressBar() {
            // Плавно обновляем прогресс
            if (Math.abs(currentProgress - targetProgress) < 0.1) {
                currentProgress = targetProgress;
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            } else {
                currentProgress += (targetProgress - currentProgress) * animationSpeed;
            }

            // Обновляем стили прогресс-бара
            progressBar.style.width = `${currentProgress}%`;
            progressBar.textContent = `${Math.round(currentProgress)}%`;

            if (currentProgress < 100) {
                progressBar.classList.add('loading');
                progressBar.classList.remove('completed');
            } else {
                progressBar.classList.remove('loading');
                progressBar.classList.add('completed');
            }

            if (animationFrameId) {
                animationFrameId = requestAnimationFrame(updateProgressBar);
            }
        }

        function updateProgress(newProgress) {
            // Валидация прогресса
            newProgress = parseFloat(newProgress);
            console.log('Обновление прогресса:', newProgress, '%');

            if (isNaN(newProgress) || newProgress < 0 || newProgress > 100) {
                console.warn('Некорректное значение прогресса:', newProgress);
                return;
            }

            // Проверяем, изменился ли прогресс
            if (targetProgress === newProgress) {
                console.log('Прогресс не изменился, пропускаем обновление');
                return;
            }

            lastProgress = newProgress;
            targetProgress = newProgress;

            // Показываем контейнер прогресса, если он скрыт
            if (progressContainer.style.display === 'none') {
                progressContainer.style.display = 'block';
            }

            // Запускаем анимацию, если она еще не запущена
            if (!animationFrameId) {
                console.log('Запускаем анимацию прогресс-бара');
                animationFrameId = requestAnimationFrame(updateProgressBar);
            }
        }

        // Функция для инициирования скачивания
        function initiateDownload() {
            if (!downloadId) {
                console.error('ID загрузки не найден');
                updateStatus('Ошибка: ID загрузки не найден', true);
                return;
            }

            const downloadUrl = `/api/download/${downloadId}`;
            console.log('Начинаем скачивание файла:', downloadUrl);

            // Создаем временную ссылку для скачивания
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.style.display = 'none';
            document.body.appendChild(link);

            // Запускаем скачивание и удаляем ссылку
            console.log('Эмулируем клик по ссылке для скачивания');
            link.click();

            // Удаляем ссылку после небольшой задержки
            setTimeout(() => {
                document.body.removeChild(link);
                console.log('Ссылка для скачивания удалена');
            }, 100);
        }

        // Обработчик клика по кнопке скачивания
        downloadButton.addEventListener('click', function(event) {
            console.log('Клик по кнопке скачивания');
            event.preventDefault();
            initiateDownload();
        });

        // Обработка отправки формы
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            lastProgress = 0;

            const url = urlInput.value.trim();
            console.log('URL для скачивания:', url);

            if (!url) {
                updateStatus('Пожалуйста, введите URL видео', true);
                return;
            }

            submitButton.disabled = true;
            progressContainer.style.display = 'block';
            downloadButtonContainer.style.display = 'none';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressBar.classList.add('loading');
            progressBar.classList.remove('completed');
            updateStatus('⏳ Загрузка началась, это может занять несколько минут...');

            try {
                console.log('Отправка запроса на сервер:', url);

                // Отправляем запрос на начало загрузки
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Ошибка сервера: ${response.status}`);
                }

                const data = await response.json();
                downloadId = data.download_id;

                if (!downloadId) {
                    throw new Error('Не удалось получить ID загрузки');
                }

                console.log('Получен download_id:', downloadId);

                // Запускаем периодический опрос статуса
                // Сначала имитируем начальный прогресс
                updateProgress(1);

                // Имитируем начальный прогресс
                let simulatedProgress = 2;
                let progressIncrement = 2;
                let slowdownFactor = 1;

                // Функция для имитации прогресса
                const simulateProgress = () => {
                    // Замедляем прирост прогресса с увеличением значения
                    if (simulatedProgress > 10 && simulatedProgress <= 30) {
                        slowdownFactor = 1.5;
                        progressIncrement = 1;
                    } else if (simulatedProgress > 30 && simulatedProgress <= 50) {
                        slowdownFactor = 2;
                        progressIncrement = 0.8;
                    } else if (simulatedProgress > 50 && simulatedProgress <= 70) {
                        slowdownFactor = 2.5;
                        progressIncrement = 0.5;
                    } else if (simulatedProgress > 70) {
                        slowdownFactor = 3;
                        progressIncrement = 0.3;
                    }

                    // Обновляем прогресс
                    simulatedProgress += progressIncrement;

                    // Ограничиваем максимальный прогресс до 85%
                    if (simulatedProgress > 85) {
                        simulatedProgress = 85;
                    }

                    console.log(`Имитация прогресса: ${simulatedProgress}%`);
                    updateProgress(simulatedProgress);
                };

                // Запускаем имитацию прогресса
                const simulationInterval = setInterval(simulateProgress, 500);

                const pollInterval = setInterval(async () => {
                    try {
                        console.log(`Запрашиваем статус загрузки для ID: ${downloadId}`);
                        const statusResponse = await fetch(`/api/progress/${downloadId}`);
                        if (!statusResponse.ok) {
                            throw new Error(`Ошибка при получении статуса: ${statusResponse.status} ${statusResponse.statusText}`);
                        }

                        const statusData = await statusResponse.json();
                        console.log('Получены данные о статусе:', statusData);

                        if (statusData.error) {
                            throw new Error(statusData.error);
                        }

                        if (statusData.progress !== undefined) {
                            // Останавливаем имитацию прогресса, если полученный прогресс больше имитируемого
                            if (statusData.progress > simulatedProgress) {
                                clearInterval(simulationInterval);
                                console.log(`Останавливаем имитацию прогресса, реальный прогресс: ${statusData.progress}%`);
                            }

                            console.log(`Обновляем прогресс: ${statusData.progress}%`);
                            updateProgress(statusData.progress);

                            // Если прогресс не меняется долгое время, продолжаем имитацию
                            if (statusData.progress < 85 && statusData.progress === lastProgress) {
                                // Если имитация остановлена, запускаем ее снова
                                if (!simulationInterval._destroyed) {
                                    // Имитация уже запущена, просто обновляем прогресс
                                    simulatedProgress = statusData.progress + 0.5;
                                } else {
                                    // Запускаем новую имитацию
                                    simulatedProgress = statusData.progress + 0.5;
                                    progressIncrement = 0.3; // Медленный прирост
                                    simulationInterval = setInterval(simulateProgress, 800); // Более медленный интервал
                                }
                            }
                        } else {
                            console.warn('Прогресс не определен в ответе');
                        }

                        if (statusData.status === 'completed') {
                            console.log('Загрузка завершена!');
                            clearInterval(pollInterval);
                            clearInterval(simulationInterval);

                            // Плавно доводим прогресс до 100%
                            const currentProgress = parseFloat(progressBar.style.width) || 0;
                            if (currentProgress < 100) {
                                // Создаем плавный переход к 100%
                                const steps = 10;
                                const increment = (100 - currentProgress) / steps;
                                let step = 0;

                                const completeInterval = setInterval(() => {
                                    step++;
                                    const newProgress = currentProgress + (increment * step);
                                    if (step >= steps || newProgress >= 100) {
                                        clearInterval(completeInterval);
                                        updateProgress(100);
                                    } else {
                                        updateProgress(newProgress);
                                    }
                                }, 100);
                            } else {
                                updateProgress(100);
                            }

                            updateStatus('✅ Загрузка завершена!');
                            downloadButtonContainer.style.display = 'block';
                            submitButton.disabled = false;
                        } else if (statusData.status === 'error') {
                            console.error('Ошибка загрузки:', statusData.error);
                            clearInterval(pollInterval);
                            clearInterval(simulationInterval);
                            throw new Error(statusData.error || 'Произошла ошибка при загрузке');
                        } else {
                            console.log(`Текущий статус: ${statusData.status}, прогресс: ${statusData.progress}%`);
                        }
                    } catch (error) {
                        clearInterval(pollInterval);
                        clearInterval(simulationInterval);
                        console.error('Ошибка при получении статуса:', error);
                        updateStatus(error.message, true);
                        progressContainer.style.display = 'none';
                        downloadButtonContainer.style.display = 'none';
                        progressBar.classList.remove('loading');
                        submitButton.disabled = false;
                    }
                }, 500); // Опрашиваем каждые 500 мс

            } catch (error) {
                console.error('Ошибка:', error);
                updateStatus(error.message, true);
                progressContainer.style.display = 'none';
                downloadButtonContainer.style.display = 'none';
                progressBar.classList.remove('loading');
                submitButton.disabled = false;
            }
        });

        // Отправка запроса на отмену при закрытии/обновлении страницы
        window.addEventListener('beforeunload', function (event) {
            if (downloadId) {
                navigator.sendBeacon(`/api/cancel/${downloadId}`);
            }
        });
    </script>
</body>
</html>
