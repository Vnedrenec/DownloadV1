<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ –ø–æ URL</title>
    <link rel="stylesheet" href="/static/style.css">

</head>
<body>
    <h1>–°–∫–∞—á–∞—Ç—å –≤–∏–¥–µ–æ –ø–æ URL</h1>
    <form id="downloadForm" method="post">
        <input type="url" id="urlInput" name="url" placeholder="–í–≤–µ–¥–∏—Ç–µ URL –≤–∏–¥–µ–æ (YouTube, Vimeo, m3u8)" required>
        <button type="submit" id="submitButton">–°–∫–∞—á–∞—Ç—å</button>
    </form>

    <div class="progress-container" style="display: none;">
        <div id="progressBar" class="progress-bar">0%</div>
    </div>
    <p id="statusMessage"></p>

    <script>
        let downloadId = null;
        let currentEventSource = null;
        let lastProgress = 0;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        const RECONNECT_DELAY = 1000; // 1 —Å–µ–∫—É–Ω–¥–∞

        // –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã DOM
        const form = document.getElementById('downloadForm');
        const urlInput = document.getElementById('urlInput');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const submitButton = document.getElementById('submitButton');
        const progressContainer = document.querySelector('.progress-container');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'error' : '';
            console.log(`–°—Ç–∞—Ç—É—Å: ${message}`);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgress(newProgress) {
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            newProgress = parseFloat(newProgress);
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', newProgress, '% (—Ç–µ–∫—É—â–∏–π:', lastProgress, '%)');
            
            if (isNaN(newProgress) || newProgress < 0 || newProgress > 100) {
                console.warn('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', newProgress);
                return;
            }
            
            lastProgress = newProgress;
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º CSS transition –¥–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
            requestAnimationFrame(() => {
                progressBar.style.transition = 'width 0.3s ease-out';
                progressBar.style.width = `${newProgress}%`;
                progressBar.textContent = `${Math.round(newProgress)}%`;
                console.log('–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω:', progressBar.style.width);
                
                if (newProgress < 100) {
                    progressBar.classList.add('loading');
                    progressBar.classList.remove('completed');
                    updateStatus(`üì• –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: ${Math.round(newProgress)}%`);
                } else {
                    progressBar.classList.remove('loading');
                    progressBar.classList.add('completed');
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–µ–∫—É—â–µ–≥–æ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function closeCurrentEventSource() {
            if (currentEventSource) {
                console.log('–ó–∞–∫—Ä—ã—Ç–∏–µ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                currentEventSource.close();
                currentEventSource = null;
                reconnectAttempts = 0;
            }
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            lastProgress = 0;
            reconnectAttempts = 0;
            
            const url = urlInput.value.trim();
            console.log('URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', url);
            
            if (!url) {
                updateStatus('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ URL –≤–∏–¥–µ–æ', true);
                return;
            }
            
            submitButton.disabled = true;
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            progressBar.textContent = '0%';
            progressBar.classList.add('loading');
            progressBar.classList.remove('completed');
            updateStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª–∞—Å—å, —ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç...');

            try {
                console.log('–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', url);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ –Ω–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }

                const data = await response.json();
                downloadId = data.download_id;
                if (!downloadId) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –∑–∞–≥—Ä—É–∑–∫–∏');
                }

                console.log('–ü–æ–ª—É—á–µ–Ω download_id:', downloadId);
                
                // –°–æ–∑–¥–∞–µ–º SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è ID
                createEventSource(downloadId);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
                await new Promise(resolve => setTimeout(resolve, 100));
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                updateStatus(error.message, true);
                progressContainer.style.display = 'none';
                progressBar.classList.remove('loading');
                submitButton.disabled = false;
            }
        });

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
        function createEventSource(download_id) {
            closeCurrentEventSource();
            
            console.log('–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            currentEventSource = new EventSource(`/api/progress_stream/${download_id}`);
            
            currentEventSource.onmessage = function(event) {
                reconnectAttempts = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
                console.log('–ü–æ–ª—É—á–µ–Ω–æ SSE —Å–æ–æ–±—â–µ–Ω–∏–µ:', event.data);
                
                try {
                    const data = JSON.parse(event.data);
                    console.log('–†–∞–∑–æ–±—Ä–∞–Ω–Ω—ã–µ SSE –¥–∞–Ω–Ω—ã–µ:', data);
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ ping —Å–æ–æ–±—â–µ–Ω–∏–π
                    if (data.ping) {
                        console.log('–ü–æ–ª—É—á–µ–Ω ping:', data.ping);
                        return;
                    }
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
                    if (data.status === 'initializing') {
                        updateStatus('‚öôÔ∏è –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏...');
                        return;
                    }
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
                    if (data.progress !== undefined) {
                        console.log('–û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å:', data.progress, '%, —Å—Ç–∞—Ç—É—Å:', data.status);
                        updateProgress(data.progress);
                        
                        if (data.status === 'downloading') {
                            updateStatus(`üì• –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è: ${Math.round(data.progress)}%`);
                        }
                    }
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
                    if (data.status === 'error') {
                        console.error('–ü–æ–ª—É—á–µ–Ω–∞ –æ—à–∏–±–∫–∞:', data.error);
                        progressBar.classList.remove('loading');
                        closeCurrentEventSource();
                        const errorMessage = data.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ';
                        throw new Error(errorMessage);
                    }
                    
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
                    if (data.status === 'completed') {
                        console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                        updateProgress(100);
                        updateStatus('‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ù–∞—á–∏–Ω–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞...');
                        
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                        closeCurrentEventSource();
                        
                        // –°–æ–∑–¥–∞–µ–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                        const downloadUrl = `/api/download/${download_id}`;
                        console.log('URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', downloadUrl);
                        
                        const link = document.createElement('a');
                        link.href = downloadUrl;
                        link.download = `video_${download_id}.mp4`;
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏ —ç–º—É–ª–∏—Ä—É–µ–º –∫–ª–∏–∫
                        document.body.appendChild(link);
                        link.click();
                        
                        // –£–¥–∞–ª—è–µ–º —Å—Å—ã–ª–∫—É –∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                        setTimeout(() => {
                            document.body.removeChild(link);
                            updateStatus('‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
                            submitButton.disabled = false;
                        }, 1000);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ SSE:', error);
                    updateStatus(error.message, true);
                    submitButton.disabled = false;
                }
            };
            
            currentEventSource.onerror = function(error) {
                console.error('–û—à–∏–±–∫–∞ SSE:', error);
                
                // –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –µ—Å–ª–∏ –Ω–µ –ø—Ä–µ–≤—ã—Å–∏–ª–∏ –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    const delay = RECONNECT_DELAY * Math.pow(2, reconnectAttempts - 1); // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                    updateStatus(`üîÑ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... (–ø–æ–ø—ã—Ç–∫–∞ ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);
                    
                    setTimeout(() => {
                        if (currentEventSource) {
                            currentEventSource.close();
                            createEventSource(download_id);
                        }
                    }, delay);
                } else {
                    closeCurrentEventSource();
                    updateStatus('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', true);
                    submitButton.disabled = false;
                }
            };
            
            currentEventSource.onopen = function() {
                console.log('SSE —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ');
                reconnectAttempts = 0;
                updateStatus('üîó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            };
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Ç–º–µ–Ω—É –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function (event) {
            if (downloadId) {
                navigator.sendBeacon(`/api/cancel/${downloadId}`);
            }
            closeCurrentEventSource();
        });
    </script>
</body>
</html>
