# Документация проекта

## Описание
Проект представляет собой FastAPI/Starlette веб-приложение для скачивания видео. Основные возможности:
- Скачивание видео с YouTube и других поддерживаемых платформ
- Поддержка HLS потоков (m3u8)
- Интеграция с ffmpeg и yt-dlp
- Отслеживание прогресса загрузки в реальном времени через SSE
- Управление загрузками через REST API
- Автоматическая очистка загруженных файлов
- Обработка ошибок и логирование

## Технический стек
- Python 3.9+
- FastAPI 0.109.1
- Starlette 0.35.1
- yt-dlp 2024.3.10
- FFmpeg
- Uvicorn 0.23.2
- Pydantic для валидации данных
- Pytest для тестирования

## API Endpoints
- `GET /` - Главная страница
- `POST /download` - Начать загрузку видео
- `GET /progress_stream/{download_id}` - SSE поток прогресса загрузки
- `GET /progress/{download_id}` - Получить текущий прогресс
- `GET /sync_progress?download_id={id}` - Синхронный запрос прогресса
- `GET /download_file/{download_id}` - Скачать готовый файл
- `POST /cancel/{download_id}` - Отменить загрузку
- `POST /log_error` - Логирование ошибок клиента

## Структура проекта
```
.
├── app.py               # Основной файл приложения с API endpoints
├── models.py           # Pydantic модели для валидации
├── requirements.txt    # Зависимости проекта
├── pyproject.toml     # Конфигурация Poetry и зависимости
├── test_app.py        # Тесты API endpoints
├── test_models.py     # Тесты моделей данных
├── downloads/         # Папка для временных файлов
├── static/            # Статические файлы
│   └── style.css     # Стили
├── views/            # Шаблоны
│   └── index.html    # Главная страница
└── README.md         # Документация
```

## Установка

### Через Poetry (рекомендуется)
```bash
# Установка зависимостей
poetry install

# Запуск
poetry run python app.py
```

### Через pip
```bash
pip install -r requirements.txt
python app.py
```

## Тестирование
Проект включает комплексный набор тестов:
- Тесты API endpoints (test_app.py)
- Тесты моделей данных (test_models.py)
- Тесты загрузки с разных платформ
- Тесты обработки ошибок

### Требования

- Python 3.8+
- pytest
- pytest-asyncio
- httpx
- fastapi
- yt-dlp

### Установка зависимостей

```bash
pip install pytest pytest-asyncio httpx fastapi yt-dlp
```

### Запуск тестов

Для запуска всех тестов:

```bash
pytest test_app.py -v
```

Для запуска конкретной группы тестов:

```bash
# Тесты API эндпоинтов
pytest test_app.py -v -k "test_download or test_cancel"

# Тесты бизнес-логики
pytest test_app.py -v -k "test_update_download_status or test_parse_ffmpeg_progress"

# Интеграционные тесты
pytest test_app.py -v -k "test_download_workflow"
```

### Покрытие тестами

Тесты охватывают следующие компоненты:

1. API Эндпоинты:
   - POST /download
   - GET /download/{download_id}
   - POST /cancel/{download_id}
   - GET /sync_progress
   - GET /progress/{download_id}
   - POST /log_error

2. Бизнес-логика:
   - Обновление статуса загрузки
   - Парсинг прогресса ffmpeg
   - Очистка имен файлов
   - Фоновые задачи (удаление файлов, очистка логов)

3. Интеграционные тесты:
   - Полный процесс загрузки
   - Обработка ошибок

### Структура тестов

- Фикстуры для создания тестового окружения
- Моки для внешних зависимостей (yt-dlp)
- Тесты позитивных и негативных сценариев
- Проверка крайних случаев
- Интеграционные тесты для проверки взаимодействия компонентов

### Отчет о покрытии

Для генерации отчета о покрытии:

```bash
pytest --cov=app test_app.py --cov-report=html
```

Отчет будет доступен в директории `htmlcov`.

## Деплой на Fly.io

### Подготовка к деплою

1. Установите Fly CLI:
```bash
# macOS
brew install flyctl

# Linux
curl -L https://fly.io/install.sh | sh
```

2. Авторизуйтесь:
```bash
fly auth login
```

3. Создайте том для хранения файлов:
```bash
fly volumes create downloads --size 10
```

### Деплой приложения

1. Инициализация проекта (если еще не инициализирован):
```bash
fly launch
```

2. Деплой:
```bash
fly deploy
```

3. Проверка статуса:
```bash
fly status
```

### Мониторинг

1. Просмотр логов:
```bash
fly logs
```

2. Мониторинг метрик:
```bash
fly metrics
```

3. Подключение к консоли:
```bash
fly ssh console
```

### Масштабирование

1. Изменение размера тома:
```bash
fly volumes update downloads --size 20
```

2. Изменение количества машин:
```bash
fly scale count 2
```

### Обновление приложения

1. Обновление кода:
```bash
fly deploy
```

2. Рестарт приложения:
```bash
fly restart
```

### Важные замечания

1. Приложение настроено на автоматическое удаление файлов через 24 часа после скачивания
2. Для работы с большими файлами настроен том размером 10GB
3. Настроена автоматическая очистка логов
4. Используется aria2c для ускорения загрузок
5. Настроен graceful shutdown с таймаутом 30 секунд

## Принцип работы

### Процесс загрузки
1. Клиент отправляет URL видео через API
2. Сервер создает уникальный ID загрузки
3. В фоновом режиме запускается загрузка:
   - YouTube/Vimeo через yt-dlp
   - HLS потоки через FFmpeg
4. Прогресс отслеживается через SSE
5. Готовый файл доступен для скачивания
6. Файл автоматически удаляется через 60 секунд после скачивания

### Безопасность
- Валидация входных данных через Pydantic
- Ограничение доступа только с localhost
- Автоматическая очистка временных файлов
- Логирование всех операций
- Ротация логов каждые 24 часа

## Автор
Vnedrenec
